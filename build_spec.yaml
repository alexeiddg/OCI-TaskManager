version: 0.1
component: build
runAs: root
shell: bash
timeoutInSeconds: 28799

env:
  variables:
    # Point to the GraalVM 22 Enterprise JDK 17 home
    JAVA_HOME: "/usr/lib64/graalvm/graalvm22-ee-java17"
    # OCIR details
    OCIR_REGION: "mx-queretaro-1"
    NAMESPACE: "ax83el69bkfn"

    TG_REPO: "mtdr-ocir-telegram"
    WEB_REPO: "mtdr-ocir-web"
    FRONTEND_REPO: "mtdr-ocir-front"
    TAG: "latest"
    REGISTRY: "mx-queretaro-1.ocir.io"

  vaultVariables:
    OCI_AUTH_TOKEN: "ocid1.vaultsecret.oc1.mx-queretaro-1.amaaaaaarjolbyqaj66jt4xtd37nrfwy7jougqc5acjucamyrzk6soq7ndja"

steps:
  - type: Command
    name: Install GraalVM & set PATH
    command: |
      yum -y install graalvm22-ee-17-native-image
      export PATH="$JAVA_HOME/bin:$PATH"

  - type: Command
    name: Root Maven build
    command: |
      echo "Using Java version:" && java -version
      mvn clean install -DskipTests -B -e -q

  - type: Command
    name: Build Telegram Docker image
    command: |
      docker build \
        --platform linux/amd64 \
        -f telegram/Dockerfile \
        -t "${REGISTRY}/${NAMESPACE}/${TG_REPO}:${TAG}" \
        telegram

  - type: Command
    name: Build Web Docker image
    command: |
      docker build \
        --platform linux/amd64 \
        -f web/Dockerfile \
        -t "${REGISTRY}/${NAMESPACE}/${WEB_REPO}:${TAG}" \
        web

  - type: Command
    name: Build Frontend Docker image
    command: |
      cd frontend
      npm install --legacy-peer-deps
      docker build \
        --platform linux/amd64 \
        -f Dockerfile \
        -t "${REGISTRY}/${NAMESPACE}/${FRONTEND_REPO}:${TAG}" \
        .
      cd ..

outputArtifacts:
  - name: telegram-image
    type: DOCKER_IMAGE
    location: "${REGISTRY}/${NAMESPACE}/${TG_REPO}:${TAG}"

  - name: web-image
    type: DOCKER_IMAGE
    location: "${REGISTRY}/${NAMESPACE}/${WEB_REPO}:${TAG}"

  - name: frontend-image
    type: DOCKER_IMAGE
    location: "${REGISTRY}/${NAMESPACE}/${FRONTEND_REPO}:${TAG}"