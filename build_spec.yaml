version: 0.1
component: build
shell: bash
timeoutInSeconds: 28799

env:
  variables:
    # Docker / OCIR info
    OCIR_REGION: mx-queretaro-1
    NAMESPACE:   ax83el69bkfn
    TG_REPO:     mtdr-ocir-telegram
    TAG:         latest
    REGISTRY:    ${OCIR_REGION}.ocir.io

  vaultVariables:
    OCI_AUTH_TOKEN: ocid1.vaultsecret.oc1.mx-queretaro-1.amaaaaaarjolbyqaj66jt4xtd37nrfwy7jougqc5acjucamyrzk6soq7ndja

steps:
  - steps:
      - name: Install GraalVM / Java 17
        type: Command
        command: |
          yum -y install graalvm22-ee-17-native-image
          export JAVA_HOME=/usr/lib64/graalvm/graalvm22-ee-java17
          export PATH=$JAVA_HOME/bin:$PATH

  - name: Root Maven build
    type: Command
    command: |
      echo "Running root mvn clean install"
       mvn clean install -DskipTests -B -e -X

  - name: Build Telegram Image
    type: Command
    command: |
      docker build \
        --platform linux/amd64,linux/arm64 \
        -f telegram/Dockerfile \
        -t ${REGISTRY}/${NAMESPACE}/${TG_REPO}:${TAG} \
        telegram

outputArtifacts:
  - name: telegram-image
    type: DOCKER_IMAGE
    location: ${REGISTRY}/${NAMESPACE}/${TG_REPO}:${TAG}